require "import"
import "StarVase"
import "UIHelper"
todoid=...


list.onItemLongClick=function(id,v,zero,one)
  id=data[one].id

  pop=PopupMenu(activity,v)
  menu=pop.Menu
  menu.add("删除").onMenuItemClick=function()
    delete(id)
  end
  pop.show()
  return true
end



fab.onClick=function()
  task(1,function()

    import "com.google.android.material.bottomsheet.BottomSheetDialog"

    local dann=import "layout.add_dialog"

    dl=BottomSheetDialog(activity)
    dl.setContentView(loadlayout(dann))
    an=dl.show()
    bottom = dl.findViewById(R.id.design_bottom_sheet);
    if (bottom != nil) then
      bottom
      .setBackgroundResource(android.R.color.transparent)
      .setPadding(math.dp2int(16),math.dp2int(16),math.dp2int(16),math.dp2int(32))
    end

    okey.onClick=function()
      if edit.getText() then
        --tab=getTable(content)
        tosettable={}
        tosettable.title=tostring(edit.getText())
        tosettable.timestamp=os.time()
        tosettable.istrue=false
        tosettable.highLight=false
        tosettable.highLightColor=0
        table.insert(tab,tosettable)

        save_as_json(tab,todoid)
        task(1,lambda->Refresh(todoid))
        MyToast.showSnackBar("Done")
      end
      dl.dismiss()
    end
    cancel.onClick=lambda -> dl.dismiss()
    --新建对话框(bt,nr,text,qd,qx,qdnr,qxnr,gb)
  end)
end



list.onItemClick=function(id,v,zero,one)
  id=data[one].id
  sql="select * from inspiration WHERE id=?"

  raw(sql,{tostring(id)})
  if cursor.moveToFirst() then
    title = cursor.getString(1);--获取第二列的值

  end
  subed("notepad","inspirationX",title,{
    id=id,
  })

end

list.onItemClick=function(id,v,zero,one)

  if v.Tag.status ~= nil then
    if v.Tag.status.Checked then
      set_check_box(one,false,todoid)
     else
      set_check_box(one,true,todoid)
    end
   else

  end
  task(1,lambda->Refresh(todoid))
end

function onResult(...)
  path,one,title,con=...
  if path == "sub/notepad/main" then
    tab=getTable(content)
    tab[one].title=title
    tab[one].content=con
    save_as_json(tab,todoid)
    task(1,lambda->Refresh(todoid))
  end
end

function onResume()
  task(1,lambda->Refresh(todoid))
end


list.onItemLongClick=function(id,v,zero,one)


  function highLight(word)
    return MyTextStyle.TextColor(word,0,utf8.len(word),0xFFF44336)
  end
  data=getTable()
  import "androidx.appcompat.widget.PopupMenu"
  pop=PopupMenu(activity,v)
  menu=pop.Menu
  menu.add("编辑内容").onMenuItemClick=function()
    tab=getTable(filename)
    if not tab.data[one].content then
      tab.data[one].content="内容"
    end
    save_as_json(tab,filename)
    Refresh(filename)
    sub("notepad","todo",getTable(filename).data[one].title,one,nil,getTable(filename).data[one].content)
  end
  menu.add("重命名").onMenuItemClick=function()

    输入对话框("重命名","标题",getTable(filename).data[one].title,"确定","取消",function() onEditDialogCallback(edit.Text) 关闭对话框(an) return edit.Text end,function() 关闭对话框(an) return nil end )

    function onEditDialogCallback(edit)
      tab=getTable(filename)
      tab.data[one].title=edit
      save_as_json(tab,filename)
      Refresh(filename)
    end
  end
  menu.add("强调显示").onMenuItemClick=function()
    tab=getTable(filename)
    old=tab.data[one].highLight
    if old == true then new=false else new=true end
    tab.data[one].highLight=new
    save_as_json(tab,filename)
    Refresh(filename)

  end


  menu.add(highLight("删除")).onMenuItemClick=function()
    task(100,function()

      import "com.google.android.material.bottomsheet.BottomSheetDialog"

      local dann=import("layout.delete_dialog")

      dl=BottomSheetDialog(activity)
      dl.setContentView(loadlayout(dann))
      an=dl.show()
      bottom = dl.findViewById(R.id.design_bottom_sheet);
      if (bottom != nil) then
        bottom
        .setBackgroundResource(android.R.color.transparent)
        .setPadding(math.dp2int(16),math.dp2int(16),math.dp2int(16),math.dp2int(32))
      end

      okey.onClick=function()
        delete(id)
        dl.dismiss()
      end
      cancel.onClick=lambda -> dl.dismiss()
    end)

    pop.show()
    双按钮对话框('删除','删除之后不能恢复,你确定要删除吗？','确定','取消',function()
      tab=getTable(filename)
      table.remove(tab.data,one)
      save_as_json(tab,filename)
      Refresh(filename) 关闭对话框(an)
    end,function()
      关闭对话框(an)
    end)
  end

  pop.show()
  return true
end